<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="robots" content="noindex,nofollow">
        <title>WEB SCREEN APP</title>
        <link rel="stylesheet" type="text/css" href="web_game_app.css">
    </head>
    <body>
        <canvas id="screen"></canvas>
        <div id="control">
            <button id="start_btn">START</button>
            <span id="time">time</span>
        </div>
        <table id="scores">
            <tr>
                <th>Rank</th>
                <th>Time</th>
            </tr>
        </table>
        <script>
            // canvas要素のDOM(Document Object Model)を取得
            const INTERVAL = 1000;
            var canvas = document.getElementById('screen');
            var context;
            var rect;
            var objArray;
            var obj;
            var timerID;
            var timeScr = document.getElementById('time'); // タイム表示要素
            var startTime;             // ゲーム開始時間
            var gameStatus = false;    // ゲームステータス
            var scores = new Array();  // タイムスコア

            class Ball{
                constructor(x, y, width, height, rotFlg, speed,image_fname ) {
                    this.posX = x;                 // CanvasのX座標
                    this.posY = y;                 // CanvasのY座標
                    this.width = width;            // 画像の横幅
                    this.height = height;          // 画像の縦幅
                    this.posXmoveDirection = true; // true : X座標増加, false : X座標減少
                    this.posYmoveDirection = true; // true : Y座標増加, false : Y座標減少  
                    this.moveSpeed = speed;        // 移動速度
                    this.rotateAngle = 0;          // 回転角度
                    this.rotateFlag = rotFlg;      // 回転フラグ
                    
                    // Imageオブジェクト生成
                    var img = new Image();     
                    
                    // 画像ファイルを読み込み
                    img.src = image_fname;     
                    
                    // 画像ファイルをセット
                    this.image = img;          
                }
                
                move(){  
                    if( this.posXmoveDirection === false ) {
                        this.posX -= this.moveSpeed;
                    } else {
                        this.posX += this.moveSpeed;  
                    }
       
                    if( this.posYmoveDirection === false ) {                 
                        this.posY -= this.moveSpeed;
                    } else {               
                        this.posY += this.moveSpeed;       
                    }
                }
                
                isHit(clickPosX, clickPosY){
                    if(Math.sqrt(Math.pow(clickPosX - this.posX,2) + Math.pow(clickPosY - this.posY,2)) < 15){
                        return true;   
                    } else {
                        return false;
                    }
                }
            }
            
            // コンテキストの取得可否チェック
            if(canvas.getContext){
                // canvas要素のコンテキストを取得
                context = canvas.getContext('2d');
                initBallObj();          //ボールの初期化
                var ret = loadScores(); //タイムスコアのロード
                if(ret !== null){ 
                    scores = ret;
                    refleshShowScores(); //タイムスコアを更新
                };
            }
            
            function move(){
                timeScr.innerHTML = showTime(getGameTP());  //表示タイムを更新
                context.clearRect(0, 0, canvas.width, canvas.height);
                objArray.forEach(function( obj ) {
                
                    if(obj.posX >= canvas.width - (obj.width / 2)){
                        obj.posXmoveDirection = false;
                    }
                
                    if(obj.posX <= (obj.width / 2)){
                        obj.posXmoveDirection = true;
                    }
                
                    if(obj.posY >= canvas.height - (obj.height / 2)){
                        obj.posYmoveDirection = false;
                    }
                
                    if(obj.posY <= (obj.height / 2)){
                        obj.posYmoveDirection = true;
                    }
                
                    obj.move();

                    context.beginPath();
                     
                    if(obj.rotateFlag === true){
                        context.save();
                        context.translate(obj.posX, obj.posY);
                        obj.rotateAngle++;
                        context.rotate(( obj.rotateAngle % 360 ) / 180 * Math.PI);
                        context.translate(-obj.width/2, -obj.height/2);
                        context.drawImage(obj.image, 0, 0);
                        context.restore();
                    } else {
                        context.drawImage(obj.image, obj.posX - (obj.width/2), obj.posY - (obj.height/2));
                    }
                });
            }
            
            /**
             * ゲーム開始
             */
            function startGame(){
                if( gameStatus === false ){
                    gameStatus = true;
                    startTime = Date.now();
                    timerID = setInterval(move, 33);
                }
            }
            
            /**
             * ボールの初期化
             */
            function initBallObj(){
                // new Ball(X座標,Y座標,横幅,高さ,移動速度,回転有無,画像ファイル名)
                objArray = new Array();
                objArray.unshift(
                    new Ball(150,75,30,30,false,0.4,"./img/image1.png"),
                    new Ball(70,120,30,30,true,0.6,"./img/image2.png"),
                    new Ball(45,115,30,30,true,0.8,"./img/image3.png"),
                    new Ball(53,45,30,30,true,1.0,"./img/image4.png"),
                    new Ball(178,103,30,30,false,1.2,"./img/image5.png"),
                    new Ball(223,141,30,30,false,1.4,"./img/image6.png"),
                    new Ball(255,111,30,30,false,1.6,"./img/image7.png"),
                    new Ball(215,121,30,30,true,1.8,"./img/image8.png")
                ); 
            }

            /**
             * CANVASクリック時の処理
             */
            canvas.onclick = function(e) {
                rect = e.target.getBoundingClientRect();
                
                for( var i = 0; i < objArray.length; i++){
                    if(objArray[i].isHit((e.clientX - rect.left), (e.clientY - rect.top)) === true){
                        objArray.splice(i,1);
                    }
                }
                
                if(objArray.length === 0){
                    gameStatus = false;
                    clearInterval(timerID);
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    context.font = "24px 'ＭＳ Ｐゴシック'";
                    var timeTP = getGameTP();
                    context.fillStyle = "gray";
                    context.fillText("クリアタイム", (canvas.width / 2) - 73, 65);
                    context.fillText(showTime(timeTP), (canvas.width / 2) - 45, 95);
                    scores.unshift(timeTP);
                    scores.sort(function(a,b){ return (a < b ? -1 : 1); } );
                    saveScores(scores)
                    refleshShowScores();
                    timeScr.innerHTML = "Time";
                    initBallObj();
                }
            }
            
            /**
             * 表示タイムの生成
             */
            function showTime(time){
                mSec = time % 1000;
                sec = Math.floor(time / 1000);
                return sec + "秒" + mSec;
            }
            
            /**
             * ゲーム開始時刻からの経過時刻（タイムスタンプ）を取得
             */
            function getGameTP() {
                return Number(Date.now()) - Number(startTime);
            }
            
            /**
             * タイムスコア一覧の表示を更新
             */
            function refleshShowScores(){
                var html = '';
                document.getElementById('scores').innerHTML = '';
                html += '<tr><th>Rank</th><th>Time</th></tr>';
                for( var i = 0; i < scores.length; i++){
                    html += '<tr><td>' + (i + 1) + '</td><td>' + showTime(Number(scores[i])) + '</td></tr>';
                }
                document.getElementById('scores').innerHTML = html; 
            }
            
            /**
             * タイムスコアをローカルストレージにセーブ
             */
            function saveScores(scores){
                var saveScores = JSON.stringify(scores);
                localStorage.setItem('scores', saveScores);
            }
            
            /**
             * タイムスコアをローカルストレージからロード
             */
            function loadScores(){
                var loadScores = localStorage.getItem('scores');
                return JSON.parse(loadScores);
            }
            
            document.getElementById('start_btn').addEventListener('click', startGame, false);
        </script>
    </body>
</html>